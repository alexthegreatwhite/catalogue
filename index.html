<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DEBUG MODE</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        body { font-family: sans-serif; padding-top: 200px; }
        
        /* BOITE DE DIAGNOSTIC ROUGE */
        #debug-box {
            position: fixed; top: 0; left: 0; right: 0; height: 180px;
            background: #333; color: #0f0; /* Noir et Vert Matrix */
            padding: 10px; font-family: monospace; font-size: 12px;
            overflow-y: scroll; z-index: 9999; border-bottom: 2px solid red;
        }
        
        .card { border: 1px solid #ccc; padding: 10px; margin: 10px; border-radius: 8px; }
        .img-test { width: 50px; height: 50px; background: #eee; }
    </style>
</head>
<body>

<div id="debug-box">INITIALISATION DIAGNOSTIC...<br></div>

<div id="content">
    <h3>Résultats ci-dessous :</h3>
    <div id="results"></div>
</div>

<script>
    const debug = document.getElementById('debug-box');
    
    function log(msg) {
        debug.innerHTML += ">> " + msg + "<br>";
        console.log(msg);
    }

    // 1. TEST DU SERVICE WORKER (On le tue pour le test)
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
            for(let registration of registrations) {
                log("Suppression ancien Service Worker...");
                registration.unregister();
            }
        });
    }

    log("Démarrage lecture CSV...");

    // 2. LECTURE DU FICHIER
    // On ajoute un nombre aléatoire (?t=...) pour empêcher le cache de bloquer
    const csvUrl = "base.csv?t=" + new Date().getTime();

    Papa.parse(csvUrl, {
        download: true,
        header: true,
        skipEmptyLines: true,
        delimiter: ";", // On force le point-virgule
        encoding: "UTF-8", // On espère que tu as fait l'étape 1 !
        
        complete: function(results) {
            log("--- LECTURE TERMINÉE ---");
            log("Lignes trouvées : " + results.data.length);
            
            if (results.errors.length > 0) {
                log("ERREURS CSV : " + JSON.stringify(results.errors[0]));
            }

            if (results.data.length > 0) {
                // Analyse de la première ligne
                const firstRow = results.data[0];
                log("COLONNES DÉTECTÉES :");
                log(Object.keys(firstRow).join(" | "));
                
                log("PREMIER PRODUIT :");
                log(JSON.stringify(firstRow));

                // Affichage test
                displayTest(results.data);
            } else {
                log("ERREUR CRITIQUE : Le fichier semble vide.");
            }
        },
        error: function(err) {
            log("ERREUR CHARGEMENT : Impossible de télécharger base.csv");
            log(err);
        }
    });

    function displayTest(products) {
        const container = document.getElementById('results');
        // On affiche juste les 5 premiers pour tester
        for(let i=0; i<5; i++) {
            if(!products[i]) break;
            let p = products[i];
            
            // On essaie de trouver la référence peu importe comment c'est écrit
            let ref = p['Référence'] || p['Reference'] || p['ref'] || "???";
            
            container.innerHTML += `
            <div class="card">
                <strong>${p['Nom'] || 'Nom inconnu'}</strong><br>
                Ref brute: ${ref}<br>
            </div>`;
        }
    }
</script>

</body>
</html>